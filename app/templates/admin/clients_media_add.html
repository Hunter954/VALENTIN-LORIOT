{% extends "admin/base.html" %}

{% block body %}
<div class="container-fluid" style="max-width: 980px;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Clients Media</h2>
      <div class="text-muted small">Enviar fotos/vídeos para um cliente específico</div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Client</label>
            {{ form.client_id(class_="form-select") }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Type</label>
            {{ form.kind(class_="form-select") }}
          </div>

          <div class="col-12">
            <label class="form-label">Title</label>
            {{ form.title(class_="form-control", placeholder="Ex: Campanha Verão") }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Order</label>
            {{ form.position(class_="form-control") }}
          </div>

          <div class="col-12">
            <label class="form-label">File</label>
            {{ form.file(class_="form-control") }}
            <div class="form-text">Imagem: png/jpg/webp • Vídeo (upload): mp4/webm/mov (opcional se usar Vimeo)</div>
          </div>

          <div class="col-12" id="vimeoRow" style="display:none;">
            <label class="form-label">Vimeo URL</label>
            {{ form.vimeo_url(class_="form-control", placeholder="https://vimeo.com/123456789") }}
            <div class="form-text">Somente quando Type = video. Você pode colar o link e deixar o upload vazio.</div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-accent">Upload</button>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-ghost">Cancelar</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Uploads já enviados</h5>
        <div class="text-muted small">(preview + excluir)</div>
      </div>
      <hr>

      {% if clients_media is defined and clients_media %}
        <div class="list-group">
          {% for m in clients_media %}
            {% set src = m.file_path %}
            {% if src and (not src.startswith('http')) and (not src.startswith('/')) %}
              {% set src = url_for('static', filename=src) %}
            {% endif %}

            <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
              <div class="d-flex gap-3" style="min-width:0;">
                <div style="width: 180px;">
                  {% if m.kind is defined and m.kind in ['video','Video','VIDEO'] %}
                    {% if src and ('vimeo.com' in src or 'player.vimeo.com' in src) %}
                      <iframe
                        src="{{ src }}"
                        style="width:100%; aspect-ratio: 16/9; border-radius:10px; border:0;"
                        allow="autoplay; fullscreen; picture-in-picture"
                        allowfullscreen
                        title="Vimeo preview"></iframe>
                    {% else %}
                      <video src="{{ src }}" style="width:100%; border-radius:10px;" controls preload="metadata"></video>
                    {% endif %}
                  {% else %}
                    <img src="{{ src }}" alt="" style="width:100%; border-radius:10px; object-fit:cover;" />
                  {% endif %}
                </div>
                <div style="min-width:0;">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div><strong>#{{ m.position }}</strong> — {{ m.title }}</div>
                    {% if m.kind is defined %}<span class="badge text-bg-secondary">{{ m.kind }}</span>{% endif %}
                    {% if m.client is defined and m.client %}
                      <span class="badge text-bg-dark">{{ m.client.name if m.client.name is defined else m.client }}</span>
                    {% endif %}
                  </div>
                  <div class="text-muted small text-truncate" style="max-width: 520px;">{{ m.file_path }}</div>
                  <a class="btn btn-sm btn-ghost mt-2" href="{{ src }}" target="_blank">Abrir arquivo</a>
                </div>
              </div>

              {% if m.id is defined %}
              {% set del_kind = 'video' if (m.kind is defined and m.kind in ['video','Video','VIDEO']) else 'image' %}
              <form method="post" action="{{ url_for('admin.clients_media_delete', kind=del_kind, item_id=m.id) }}">
                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Remover este item?')">Excluir</button>
              </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">Nenhum upload ainda.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    const kindSel = document.querySelector('select[name="kind"]');
    const vimeoRow = document.getElementById('vimeoRow');
    function sync(){
      if(!kindSel || !vimeoRow) return;
      vimeoRow.style.display = (kindSel.value === 'video') ? '' : 'none';
    }
    if(kindSel){ kindSel.addEventListener('change', sync); sync(); }
  })();
</script>
{% endblock %}
