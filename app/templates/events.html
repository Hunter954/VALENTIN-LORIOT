{% extends "base.html" %}
{% block body %}
<header class="top-nav">
  <div class="top-nav-inner">
    <div class="brand">
      {% if settings and settings.brand_logo_path %}
        <img class="brand-logo" src="{{ settings.brand_logo_path }}" alt="{{ settings.site_title }}" />
      {% else %}
        <div class="brand-mark">VL</div>
      {% endif %}
    </div>
    <nav class="menu">
      <a href="{{ url_for('main.home') }}">Home</a>
      <a href="{{ url_for('main.portfolio') }}">Portfolio</a>
      <a href="{{ url_for('main.events') }}" class="active">Events</a>
      <a href="{{ url_for('main.clients') }}">Clients</a>
      <a href="{{ url_for('main.about') }}">About Us</a>
      <a href="{{ url_for('main.contact') }}">Contact</a>
    </nav>
    <div class="social">
      {% for s in socials %}
        <a href="{{ s.url }}" aria-label="{{ s.name }}" title="{{ s.name }}"><i class="{{ s.icon_class }}"></i></a>
      {% endfor %}
    </div>
  </div>
</header>

<section class="section works" style="padding-top:140px;">
  <div class="section-inner">
    <h1 class="section-title" style="text-align:center;margin-bottom:30px;">EVENTS</h1>

    <div class="works-grid">
      {% for m in media %}
        <div class="works-item">
          {% if m.kind == 'video' %}
            {% set src = (m.file_path or '') %}
            {% set is_vimeo = ('vimeo.com' in src) or ('player.vimeo.com' in src) %}
            <a href="#" class="media-popup-link" data-popup="1" data-type="video" data-src="{{ src }}">
              {% if is_vimeo %}
                <iframe class="works-embed vimeo-bg" data-src="{{ src }}" src="" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen title="Vimeo"></iframe>
              {% else %}
                <video class="works-video" playsinline muted autoplay preload="metadata" loop>
                  <source src="{{ src }}" type="video/mp4">
                </video>
              {% endif %}
            </a>
          {% else %}
            <a href="#" class="media-popup-link" data-popup="1" data-type="image" data-src="{{ m.file_path }}"><img class="ig-photo" src="{{ m.file_path }}" alt="{{ m.title or ('Event ' ~ loop.index) }}" /></a>
          {% endif %}
          {% if m.title %}
            <div class="works-item-overlay">{{ m.title }}</div>
          {% endif %}
        </div>
      {% endfor %}
      {% if media|length == 0 %}
        <div class="works-empty">Add items in /admin → Events.</div>
      {% endif %}
    </div>
  </div>
</section>
<!-- MEDIA POPUP (foto/vídeo) -->
<div id="mediaModal" class="media-modal" aria-hidden="true">
  <div class="media-modal__backdrop" data-close="1"></div>

  <div class="media-modal__content" role="dialog" aria-modal="true">
    <button class="media-modal__close" type="button" data-close="1" aria-label="Close">×</button>

    <img id="mediaModalImg" class="media-modal__img" alt="" style="display:none;">
    <video id="mediaModalVideo" class="media-modal__video" controls playsinline controlsList="nodownload noplaybackrate" disablepictureinpicture oncontextmenu="return false;" style="display:none;"></video>
    <iframe id="mediaModalVimeo" class="media-modal__video" style="display:none; border:0;" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen title="Vimeo player"></iframe>
  </div>
</div>

<style>
  .media-modal { position: fixed; inset: 0; display: none; z-index: 9999; }
  .media-modal.is-open { display: block; }
  .media-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.75); }
  .media-modal__content {
    position: relative;
    width: min(1000px, calc(100% - 24px));
    margin: 60px auto;
    background: #0b0b0b;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 12px;
    box-shadow: 0 20px 70px rgba(0,0,0,.6);
  }
  .media-modal__close {
    position: absolute; top: 8px; right: 10px;
    width: 36px; height: 36px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.06);
    color: #fff; font-size: 22px; cursor: pointer;
  }
  .media-modal__img { width: 100%; height: auto; border-radius: 10px; }
  .media-modal__video { width: 100%; max-height: 70vh; border-radius: 10px; }
  .works-embed { position:absolute; inset:0; width:100%; height:100%; border:0; pointer-events:none; }
  .works-item a.media-popup-link { display:block; color: inherit; text-decoration:none; }
  /* Hide any residual video UI on thumbnails */
  .works-video::-webkit-media-controls { display:none !important; }
  .works-video::-webkit-media-controls-enclosure { display:none !important; }
</style>

<script>
  (function () {
    const modal = document.getElementById("mediaModal");
    const img = document.getElementById("mediaModalImg");
    const video = document.getElementById("mediaModalVideo");
    const vimeoFrame = document.getElementById("mediaModalVimeo");

    // Prevent right-click download menu on the modal video (best-effort)
    video.addEventListener('contextmenu', (e) => e.preventDefault());

    function openModal({ type, src, poster }) {
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
      document.documentElement.style.overflow = "hidden";

      img.style.display = "none";
      img.removeAttribute("src");
      video.style.display = "none";
      video.pause();
      video.removeAttribute("src");
      video.load();
      vimeoFrame.style.display = "none";
      vimeoFrame.removeAttribute("src");

      if (type === "image") {
        img.src = src;
        img.style.display = "block";
      } else {
        const isVimeo = /vimeo\.com\/(?:video\/)?\d+|player\.vimeo\.com\/video\/\d+/i.test(src || "");
        if (isVimeo) {
          const idMatch = String(src).match(/(?:vimeo\.com\/(?:video\/)?|player\.vimeo\.com\/video\/)(\d+)/i);
          const id = idMatch ? idMatch[1] : null;
          if (id) {
            const params = new URLSearchParams({autoplay:"1", muted:"0", loop:"0", title:"0", byline:"0", portrait:"0", dnt:"1"});
            vimeoFrame.src = "https://player.vimeo.com/video/" + id + "?" + params.toString();
          } else {
            vimeoFrame.src = src;
          }
          vimeoFrame.style.display = "block";
        } else {
          if (poster) video.setAttribute("poster", poster);
          video.src = src;
          video.style.display = "block";
          setTimeout(() => video.play().catch(() => {}), 50);
        }
      }
    }

    function closeModal() {
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      document.documentElement.style.overflow = "";

      video.pause();
      video.removeAttribute("src");
      video.load();
      vimeoFrame.removeAttribute("src");
      img.removeAttribute("src");
    }

    modal.addEventListener("click", (e) => {
      if (e.target && e.target.dataset && e.target.dataset.close) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
    });

    document.addEventListener("click", (e) => {
      const el = e.target.closest("[data-popup]");
      if (!el) return;

      e.preventDefault();

      const type = el.getAttribute("data-type") || "image";
      const src = el.getAttribute("data-src");
      const poster = el.getAttribute("data-poster") || "";

      if (!src) return;
      openModal({ type, src, poster });
    });
  })();
</script>

<script>
  (function(){
    function bgUrl(raw){
      if(!raw) return "";
      const m = String(raw).match(/(?:vimeo\.com\/(?:video\/)?|player\.vimeo\.com\/video\/)(\d+)/i);
      if(!m) return raw;
      const id = m[1];
      const p = new URLSearchParams({background:"1", autoplay:"1", loop:"1", muted:"1", autopause:"0", title:"0", byline:"0", portrait:"0", dnt:"1"});
      return "https://player.vimeo.com/video/"+id+"?"+p.toString();
    }
    document.querySelectorAll('iframe.vimeo-bg').forEach((f)=>{f.src = bgUrl(f.getAttribute('data-src')||"");});
  })();
</script>
{% endblock %}
